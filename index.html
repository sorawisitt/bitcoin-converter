<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Professional Bitcoin, Satoshi, and Thai Baht converter with real-time Bitkub rates, Halving countdown, and Network fees.">
    <title>Bitcoin Converter (BTC, SAT, THB)</title>
    <link rel="icon" type="image/webp" href="https://sorawisit.com/favcon.webp">
    
    <!-- Theme Engine: Prevent White Flash -->
    <script>
        (function() {
            const savedMode = localStorage.getItem('themeMode') || 'system';
            let themeToApply = savedMode;
            if (savedMode === 'system') {
                themeToApply = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            document.documentElement.setAttribute('data-theme', themeToApply);
        })();
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #f7931a;
            --primary-glow: rgba(247, 147, 26, 0.2);
            --primary-hover: #e07b00;
            --bg-body: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.75);
            --card-border: rgba(255, 255, 255, 0.9);
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --input-bg: rgba(255, 255, 255, 0.9);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
            --radius: 24px;
            --success: #10b981;
            --danger: #ef4444;
        }

        [data-theme="dark"] {
            --bg-body: #0b0e14;
            --card-bg: rgba(17, 24, 39, 0.7);
            --card-border: rgba(255, 255, 255, 0.06);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(15, 23, 42, 0.8);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --primary-glow: rgba(247, 147, 26, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            background-image: 
                radial-gradient(at 0% 0%, var(--primary-glow) 0, transparent 50%),
                radial-gradient(at 100% 100%, var(--primary-glow) 0, transparent 50%);
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            transition: background-color 0.4s ease, color 0.4s ease;
            overflow-x: hidden;
        }

        .main-container {
            width: 100%;
            max-width: 850px;
            margin-top: 2vh;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 32px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        header {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .btc-icon {
            font-size: 2.5rem;
            color: var(--primary);
            filter: drop-shadow(0 0 15px var(--primary-glow));
        }

        h1 {
            font-weight: 800;
            font-size: 1.85rem;
            letter-spacing: -0.04em;
            background: linear-gradient(135deg, var(--text-main) 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .credit {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        /* Dashboard Stats Grid Alignment Fix */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 32px;
        }

        .stat-box {
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 16px 8px;
            text-align: center;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100px;
        }

        .stat-box.primary-stat {
            grid-column: 1 / -1;
            border-color: var(--primary);
            background: linear-gradient(145deg, var(--input-bg), var(--primary-glow));
            box-shadow: 0 10px 20px -5px var(--primary-glow);
            padding: 24px 20px;
            margin-bottom: 4px;
            min-height: auto;
        }

        .ticker-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-muted);
            font-weight: 800;
            margin-bottom: 6px;
            display: block;
        }

        .ticker-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.02em;
        }

        .primary-stat .ticker-value {
            font-size: 1.75rem;
            color: var(--primary);
            line-height: 1.2;
        }

        .sub-value {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 6px;
            font-weight: 600;
        }

        /* Tech Input Styling */
        .converter-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 20px;
        }

        .input-wrapper label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 8px;
            padding-left: 4px;
        }

        .input-container {
            position: relative;
        }

        .input-container input {
            width: 100%;
            padding: 16px 54px 16px 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.15rem;
            font-weight: 600;
            background: var(--input-bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            color: var(--text-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-container input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-glow);
        }

        .copy-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.4rem;
            padding: 8px;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.2s;
        }

        .copy-btn:active { opacity: 1; transform: translateY(-50%) scale(0.9); }

        #supply-warning {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
            display: none;
            border: 1px solid rgba(239, 68, 68, 0.2);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .controls-row {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            align-items: center;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .btn {
            height: 48px;
            padding: 0 16px;
            border-radius: 14px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
            display: inline-flex;
            flex: 1;
            justify-content: center;
            align-items: center;
            gap: 8px;
            background: var(--input-bg);
            color: var(--text-main);
        }

        .btn-primary { 
            background: var(--primary); 
            color: white; 
            border: none;
            box-shadow: 0 4px 15px var(--primary-glow);
        }
        
        .btn:active { transform: scale(0.96); }

        /* Comparison Grid */
        .comparison-section { margin-bottom: 40px; }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            font-size: 1.25rem;
            font-weight: 800;
            letter-spacing: -0.03em;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .comparison-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 16px;
            border-radius: 20px;
            position: relative;
            transition: all 0.3s ease;
            backdrop-filter: blur(12px);
        }

        .item-icon { 
            font-size: 1.25rem; 
            margin-bottom: 8px; 
            display: inline-block;
            background: var(--bg-body);
            width: 38px;
            height: 38px;
            line-height: 38px;
            text-align: center;
            border-radius: 10px;
        }

        .item-name { font-weight: 700; font-size: 0.85rem; margin-bottom: 2px; color: var(--text-main); }
        .item-thb { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; margin-bottom: 12px; }
        .item-sat { font-family: 'JetBrains Mono', monospace; color: var(--primary); font-weight: 800; font-size: 1.1rem; letter-spacing: -0.04em; }

        .comparison-card.custom { border: 2px dashed var(--primary); }

        /* Modal */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: flex-end; 
            z-index: 2000;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-content input {
            width: 100%;
            padding: 14px;
            margin-bottom: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text-main);
            font-family: inherit;
        }

        footer {
            margin-top: 20px;
            padding-bottom: 60px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.75rem;
            line-height: 1.8;
        }

        footer a { color: var(--primary); text-decoration: none; font-weight: 600; }

        @media (min-width: 769px) {
            #modal-overlay { align-items: center; }
            .modal-content { border-radius: 24px; animation: fadeIn 0.3s ease; }
            .comparison-grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
            h1 { font-size: 2.25rem; }
            .btc-icon { font-size: 3rem; }
            .primary-stat .ticker-value { font-size: 2.5rem; }
            .ticker-value { font-size: 1.1rem; }
            .glass-card { padding: 40px; }
            .stats-row { gap: 16px; grid-template-columns: repeat(3, 1fr); }
            .stat-box { min-height: 110px; }
        }

        @media (max-width: 768px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .stat-box:nth-child(4) { grid-column: span 2; min-height: 80px; }
        }
    </style>
</head>
<body>

    <div id="toast" style="position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--text-main); color: var(--bg-body); padding: 12px 24px; border-radius: 50px; font-weight: 600; z-index: 3000; transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); font-size: 0.8rem; white-space: nowrap; box-shadow: var(--shadow-lg);">Copied to clipboard!</div>

    <div id="modal-overlay" onclick="if(event.target === this) closeModal()">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; font-weight: 800;">Add Custom Goal</h3>
            <input type="text" id="new-item-name" placeholder="Target Name (e.g. Dream House)">
            <input type="number" id="new-item-price" placeholder="Target Price (THB)">
            <input type="text" id="new-item-icon" placeholder="Icon Emoji (e.g. üè∞)">
            <div style="display: flex; gap: 12px; margin-top: 10px;">
                <button class="btn" style="flex: 1;" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="saveCustomItem()">Save Goal</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <header>
            <div class="logo-area">
                <span class="btc-icon">‚Çø</span>
                <h1>Bitcoin Converter</h1>
            </div>
            <p class="credit">Dev <a href="https://x.com/sorawisitt" target="_blank">@SorawisitT</a></p>
        </header>

        <div class="glass-card">
            <div class="stats-row">
                <div class="stat-box primary-stat">
                    <span class="ticker-label">BTC Market Price</span>
                    <div class="ticker-value" id="ticker-btc-thb">‡∏ø0.00</div>
                    <div class="sub-value" id="ticker-thb-sat">---</div>
                </div>
                
                <div class="stat-box">
                    <span class="ticker-label">Halving</span>
                    <div class="ticker-value" id="halving-timer">--d --h</div>
                    <div class="sub-value">Next Reward Cut</div>
                </div>
                <div class="stat-box">
                    <span class="ticker-label">Network Fee</span>
                    <div class="ticker-value" id="fee-high">-- sat</div>
                    <div class="sub-value">Priority Next Block</div>
                </div>
                <div class="stat-box">
                    <span class="ticker-label">Sync Status</span>
                    <div class="ticker-value" id="countdown-text">30s</div>
                    <div class="sub-value" id="status-text">Connected</div>
                </div>
            </div>

            <div class="converter-grid">
                <div class="input-wrapper">
                    <label>Thai Baht <span>THB</span></label>
                    <div class="input-container">
                        <input type="text" id="thb-input" placeholder="0" inputmode="numeric">
                        <button class="copy-btn" onclick="copyValue('thb-input')">üìÑ</button>
                    </div>
                </div>
                <div class="input-wrapper">
                    <label>Satoshi <span>SAT</span></label>
                    <div class="input-container">
                        <input type="text" id="sat-input" placeholder="0" inputmode="numeric">
                        <button class="copy-btn" onclick="copyValue('sat-input')">üìÑ</button>
                    </div>
                </div>
                <div class="input-wrapper">
                    <label>Bitcoin <span>BTC</span></label>
                    <div class="input-container">
                        <input type="text" id="btc-input" placeholder="0" inputmode="decimal">
                        <button class="copy-btn" onclick="copyValue('btc-input')">üìÑ</button>
                    </div>
                </div>
            </div>

            <div id="supply-warning">
                ‚ö†Ô∏è Warning: Only 21,000,000 Bitcoin will ever exist. Values capped to total supply.
            </div>

            <div class="controls-row">
                <button class="btn" id="theme-toggle">
                    <span id="theme-icon">üåì</span> <span id="theme-label">System</span>
                </button>
                <button class="btn btn-primary" id="refresh-btn">üîÑ Update</button>
            </div>
        </div>

        <div class="comparison-section">
            <div class="section-header">
                <h2>The Bitcoin Standard</h2>
            </div>
            <div class="comparison-grid" id="standard-grid"></div>
        </div>

        <div class="comparison-section" id="goals-section" style="display: none;">
            <div class="section-header">
                <h2>Custom Savings Goals</h2>
                <button class="btn" style="height: 32px; padding: 0 12px; font-size: 0.75rem; flex: initial;" onclick="openModal()">+ New Goal</button>
            </div>
            <div class="comparison-grid" id="goals-grid"></div>
        </div>

        <div id="no-goals-cta" style="text-align: center; margin-bottom: 60px;">
             <button class="btn" style="max-width: 280px; margin: 0 auto;" onclick="openModal()">+ Add Custom Goal</button>
        </div>

        <footer>
            Node Sync: <a href="https://bitkub.com" target="_blank">Bitkub</a> & <a href="https://mempool.space" target="_blank">Mempool</a><br>
            Purchasing Power Parity ‚Ä¢ <a href="https://sorawisit.com" target="_blank">sorawisit.com</a><br>
            ‚ö° <a href="https://pay.blink.sv/SORAWISIT" target="_blank">Donate Sats</a>
        </footer>
    </div>

    <script>
        (function() {
            const MAX_BTC = 21000000;
            const state = {
                rate: 3200000,
                themeMode: localStorage.getItem('themeMode') || 'system',
                secondsRemaining: 30,
                nextHalving: new Date('2028-04-17T00:00:00Z').getTime(),
                customItems: JSON.parse(localStorage.getItem('customGoals')) || [],
                baseItems: [
                    { name: "Coffee", price: 120, icon: "‚òï" },
                    { name: "Street Food Meal", price: 60, icon: "üçú" },
                    { name: "BTS Fare", price: 20, icon: "üöá" },
                    { name: "Movie Ticket", price: 240, icon: "üé¨" },
                    { name: "iPhone 17 Pro", price: 43900, icon: "üì±" },
                    { name: "Condo Rent", price: 15000, icon: "üè†" },
                    { name: "Full Tank of Gas", price: 1200, icon: "‚õΩ" },
                    { name: "Gold (1 Baht)", price: 65000, icon: "üìÄ" },
                    { name: "Tesla Model 3", price: 1149000, icon: "üöó" }
                ]
            };

            const els = {
                thb: document.getElementById('thb-input'),
                sat: document.getElementById('sat-input'),
                btc: document.getElementById('btc-input'),
                tickerBtc: document.getElementById('ticker-btc-thb'),
                tickerSat: document.getElementById('ticker-thb-sat'),
                halving: document.getElementById('halving-timer'),
                fee: document.getElementById('fee-high'),
                countdown: document.getElementById('countdown-text'),
                status: document.getElementById('status-text'),
                standardGrid: document.getElementById('standard-grid'),
                goalsGrid: document.getElementById('goals-grid'),
                goalsSection: document.getElementById('goals-section'),
                noGoalsCta: document.getElementById('no-goals-cta'),
                modal: document.getElementById('modal-overlay'),
                toast: document.getElementById('toast'),
                themeToggle: document.getElementById('theme-toggle'),
                themeLabel: document.getElementById('theme-label'),
                themeIcon: document.getElementById('theme-icon'),
                warning: document.getElementById('supply-warning')
            };

            function init() {
                applyTheme(); // Updates labels/icons based on initial state
                fetchAllData();
                setupListeners();
                setInterval(updateTickers, 1000);
                setInterval(updateHalving, 1000);
            }

            function setupListeners() {
                els.thb.oninput = (e) => handleInput(e, 'thb');
                els.sat.oninput = (e) => handleInput(e, 'sat');
                els.btc.oninput = (e) => handleInput(e, 'btc');
                document.getElementById('refresh-btn').onclick = fetchAllData;
                els.themeToggle.onclick = toggleTheme;
                
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                    if (state.themeMode === 'system') applyTheme();
                });
            }

            async function fetchAllData() {
                state.secondsRemaining = 30;
                els.status.textContent = "Updating...";
                try {
                    const bResp = await fetch(`https://api.bitkub.com/api/market/ticker?sym=THB_BTC&t=${Date.now()}`);
                    const bData = await bResp.json();
                    if(bData.THB_BTC) state.rate = parseFloat(bData.THB_BTC.last);

                    const fResp = await fetch('https://mempool.space/api/v1/fees/recommended');
                    const fData = await fResp.json();
                    els.fee.textContent = `${fData.fastestFee} sat/vB`;

                    updateStaticUI();
                    els.status.textContent = "Connected";
                } catch (e) {
                    els.status.textContent = "Offline";
                }
            }

            function updateTickers() {
                if (state.secondsRemaining > 0) {
                    state.secondsRemaining--;
                    els.countdown.textContent = `${state.secondsRemaining}s`;
                } else {
                    fetchAllData();
                }
            }

            function updateHalving() {
                const now = new Date().getTime();
                const dist = state.nextHalving - now;
                const days = Math.floor(dist / (1000 * 60 * 60 * 24));
                const hours = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                els.halving.textContent = `${days}d ${hours}h`;
            }

            function updateStaticUI() {
                els.tickerBtc.textContent = `‡∏ø${state.rate.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                const satsPerThb = Math.round(100000000 / state.rate);
                els.tickerSat.textContent = `1 THB ‚âà ${satsPerThb.toLocaleString()} sats`;
                renderComparison();
            }

            function renderComparison() {
                els.standardGrid.innerHTML = '';
                state.baseItems.forEach(item => els.standardGrid.appendChild(createCard(item)));

                els.goalsGrid.innerHTML = '';
                if (state.customItems.length > 0) {
                    els.goalsSection.style.display = 'block';
                    els.noGoalsCta.style.display = 'none';
                    state.customItems.forEach((item, idx) => els.goalsGrid.appendChild(createCard(item, true, idx)));
                } else {
                    els.goalsSection.style.display = 'none';
                    els.noGoalsCta.style.display = 'block';
                }
            }

            function createCard(item, isCustom = false, idx = null) {
                const btcVal = item.price / state.rate;
                const satVal = Math.round(btcVal * 100000000);
                const card = document.createElement('div');
                card.className = `comparison-card ${isCustom ? 'custom' : ''}`;
                card.innerHTML = `
                    ${isCustom ? `<button style="position:absolute;top:8px;right:8px;background:none;border:none;color:var(--danger);cursor:pointer;font-weight:bold;font-size:1.1rem;padding:4px;" onclick="deleteItem(${idx})">√ó</button>` : ''}
                    <span class="item-icon">${item.icon}</span>
                    <div class="item-name">${item.name}</div>
                    <div class="item-thb">‡∏ø${Math.round(item.price).toLocaleString()}</div>
                    <div class="item-sat">${satVal.toLocaleString()} sats</div>
                `;
                return card;
            }

            function formatNumber(num, isBTC = false) {
                if (isNaN(num)) return "0";
                if (isBTC) {
                    return parseFloat(num.toFixed(8)).toLocaleString('en-US', { maximumFractionDigits: 8 });
                }
                return Math.round(num).toLocaleString('en-US');
            }

            function handleInput(e, source) {
                const input = e.target;
                const originalSelectionStart = input.selectionStart;
                const originalValue = input.value;
                
                let rawValStr = source === 'btc' ? input.value.replace(/[^0-9.]/g, '') : input.value.replace(/\D/g, '');
                
                if (source === 'btc') {
                    const parts = rawValStr.split('.');
                    if (parts.length > 2) rawValStr = parts[0] + '.' + parts.slice(1).join('');
                }

                if (rawValStr === '' || rawValStr === '.') {
                    if (rawValStr === '') {
                        els.thb.value = '';
                        els.sat.value = '';
                        els.btc.value = '';
                        els.warning.style.display = 'none';
                    }
                    return;
                }

                let val = parseFloat(rawValStr);
                let currentBTC = 0;
                let showWarning = false;

                if (source === 'thb') {
                    currentBTC = val / state.rate;
                } else if (source === 'sat') {
                    currentBTC = val / 100000000;
                } else if (source === 'btc') {
                    currentBTC = val;
                }

                if (currentBTC > MAX_BTC) {
                    currentBTC = MAX_BTC;
                    showWarning = true;
                    if (source === 'thb') val = MAX_BTC * state.rate;
                    if (source === 'sat') val = MAX_BTC * 100000000;
                    if (source === 'btc') val = MAX_BTC;
                    rawValStr = val.toString();
                }

                els.warning.style.display = showWarning ? 'block' : 'none';

                let formattedTyped;
                if (source === 'btc') {
                    const [intPart, decPart] = rawValStr.split('.');
                    formattedTyped = parseInt(intPart || '0', 10).toLocaleString('en-US');
                    if (decPart !== undefined) formattedTyped += '.' + decPart.substring(0, 8);
                } else {
                    formattedTyped = Math.round(val).toLocaleString('en-US');
                }
                
                input.value = formattedTyped;

                const addedChars = input.value.length - originalValue.length;
                let newCursorPos = originalSelectionStart + addedChars;
                input.setSelectionRange(newCursorPos, newCursorPos);

                if (source === 'thb') {
                    els.sat.value = formatNumber(currentBTC * 100000000);
                    els.btc.value = formatNumber(currentBTC, true);
                } else if (source === 'sat') {
                    els.thb.value = formatNumber(currentBTC * state.rate);
                    els.btc.value = formatNumber(currentBTC, true);
                } else if (source === 'btc') {
                    els.thb.value = formatNumber(currentBTC * state.rate);
                    els.sat.value = formatNumber(currentBTC * 100000000);
                }
            }

            window.openModal = () => els.modal.style.display = 'flex';
            window.closeModal = () => els.modal.style.display = 'none';
            window.saveCustomItem = () => {
                const name = document.getElementById('new-item-name').value;
                const price = parseFloat(document.getElementById('new-item-price').value);
                const icon = document.getElementById('new-item-icon').value || 'üéØ';
                if (name && price) {
                    state.customItems.push({ name, price, icon });
                    localStorage.setItem('customGoals', JSON.stringify(state.customItems));
                    renderComparison();
                    closeModal();
                }
            };
            window.deleteItem = (idx) => {
                state.customItems.splice(idx, 1);
                localStorage.setItem('customGoals', JSON.stringify(state.customItems));
                renderComparison();
            };
            window.copyValue = (id) => {
                const el = document.getElementById(id);
                const text = el.value.replace(/,/g, '');
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                els.toast.style.transform = 'translateX(-50%) translateY(0)';
                setTimeout(() => els.toast.style.transform = 'translateX(-50%) translateY(100px)', 2000);
            };

            function toggleTheme() {
                const modes = ['system', 'light', 'dark'];
                const currentIndex = modes.indexOf(state.themeMode);
                state.themeMode = modes[(currentIndex + 1) % modes.length];
                localStorage.setItem('themeMode', state.themeMode);
                applyTheme();
            }

            function applyTheme() {
                let actualTheme = state.themeMode;
                if (state.themeMode === 'system') {
                    actualTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                    els.themeIcon.textContent = 'üåì';
                    els.themeLabel.textContent = 'System';
                } else {
                    els.themeIcon.textContent = state.themeMode === 'dark' ? 'üåô' : '‚òÄÔ∏è';
                    els.themeLabel.textContent = state.themeMode.charAt(0).toUpperCase() + state.themeMode.slice(1);
                }
                document.documentElement.setAttribute('data-theme', actualTheme);
            }

            init();
        })();
    </script>
</body>
</html>
